<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS1.6 WebRTC Relay Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .card h2 {
            margin-bottom: 15px;
            color: #fff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        
        .server-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .server-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.5);
            transform: translateY(-2px);
        }
        
        .server-item.connecting {
            border: 2px solid #ff9800;
            opacity: 0.7;
        }
        
        .server-info {
            display: flex;
            flex-direction: column;
        }
        
        .server-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .server-details {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .status-indicator {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-ok {
            background: #4CAF50;
            color: white;
        }
        
        .status-error {
            background: #f44336;
            color: white;
        }
        
        .status-unknown {
            background: #ff9800;
            color: white;
        }
        
        .debug-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .debug-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9em;
        }
        
        .debug-item:last-child {
            border-bottom: none;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .metric-label {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .loading {
            opacity: 0.5;
        }
        
        .timestamp {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .test-results {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .test-step {
            font-size: 0.85em;
            margin: 2px 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ CS1.6 WebRTC Relay Dashboard</h1>
        
        <div class="dashboard-grid">
            <!-- Game Servers (Primary) -->
            <div class="card">
                <h2>üéØ Game Servers</h2>
                <div id="gameServers">
                    <div class="server-item">
                        <div class="server-info">
                            <div class="server-name">Loading...</div>
                            <div class="server-details">Checking servers...</div>
                        </div>
                        <div class="status-indicator status-unknown">Checking</div>
                    </div>
                </div>
            </div>
            
            <!-- Debug Console -->
            <div class="card">
                <h2>üîß System Debug</h2>
                <div class="debug-controls">
                    <button id="runDebugBtn" onclick="runDebugSuite()">üîÑ Run Debug Suite</button>
                </div>
                
                <div id="debugResults">
                    <div class="debug-item">
                        <span>Python Relay</span>
                        <span class="status-indicator status-unknown">Unknown</span>
                    </div>
                    <div class="debug-item">
                        <span>Go WebRTC</span>
                        <span class="status-indicator status-unknown">Unknown</span>
                    </div>
                    <div class="debug-item">
                        <span>Pipeline Test</span>
                        <span class="status-indicator status-unknown">Unknown</span>
                    </div>
                </div>
                
                <!-- Live Metrics -->
                <div class="metrics-grid" id="metrics">
                    <div class="metric-card">
                        <div class="metric-value">-</div>
                        <div class="metric-label">Loading...</div>
                    </div>
                </div>
                
                <div id="testResults" class="test-results" style="display: none;"></div>
            </div>
        </div>
        
        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        let debugRunning = false;
        
        // Initialize dashboard
        window.addEventListener('load', () => {
            loadGameServers();
            refreshMetrics();
        });
        
        async function loadGameServers() {
            const serversContainer = document.getElementById('gameServers');
            serversContainer.classList.add('loading');
            
            try {
                const serversResponse = await fetch('/api/servers');
                const servers = await serversResponse.json();
                
                serversContainer.innerHTML = '';
                
                for (const [serverName, serverInfo] of Object.entries(servers.servers)) {
                    const statusClass = serverInfo.status === 'online' ? 'status-ok' : 'status-error';
                    const statusText = serverInfo.status === 'online' ? 'Join' : 'Offline';
                    
                    const serverElement = document.createElement('div');
                    serverElement.className = 'server-item';
                    if (serverInfo.status === 'online') {
                        serverElement.onclick = () => connectToServer(serverName, serverInfo);
                    }
                    
                    // Create player count display
                    const playerCount = serverInfo.status === 'online' ? 
                        `${serverInfo.players}/${serverInfo.max_players}` : 
                        '0/0';
                    
                    // Create map display
                    const mapName = serverInfo.map !== 'unknown' ? serverInfo.map : '';
                    
                    serverElement.innerHTML = `
                        <div class="server-info">
                            <div class="server-name">${serverInfo.name}</div>
                            <div class="server-details">
                                ${mapName ? `${mapName} ‚Ä¢ ` : ''}${playerCount} players ‚Ä¢ ${serverInfo.host}:${serverInfo.port}
                            </div>
                        </div>
                        <div class="status-indicator ${statusClass}">
                            ${statusText}
                        </div>
                    `;
                    
                    serversContainer.appendChild(serverElement);
                }
                
                // If no servers found
                if (Object.keys(servers.servers).length === 0) {
                    serversContainer.innerHTML = '<div class="server-item"><div class="server-info"><div class="server-name">No servers found</div><div class="server-details">No CS1.6 servers detected</div></div></div>';
                }
                
            } catch (error) {
                console.error('Failed to load servers:', error);
                serversContainer.innerHTML = '<div class="server-item"><div class="server-info"><div class="server-name">Error loading servers</div><div class="server-details">Failed to fetch server list</div></div></div>';
            }
            
            serversContainer.classList.remove('loading');
        }
        
        async function connectToServer(serverName, serverInfo) {
            const serverElements = document.querySelectorAll('.server-item');
            const clickedElement = event.currentTarget;
            
            // Reset all server states
            serverElements.forEach(el => el.classList.remove('connecting'));
            clickedElement.classList.add('connecting');
            
            try {
                // Open Xash client with connect command for this specific server
                const clientUrl = `/client?connect=${serverInfo.host}:${serverInfo.port}&server=${serverName}`;
                window.open(clientUrl, '_blank');
                
                // Update UI to show connecting state
                const originalDetails = clickedElement.querySelector('.server-details').innerHTML;
                clickedElement.querySelector('.server-details').innerHTML = 
                    `Connecting to ${serverInfo.host}:${serverInfo.port}...`;
                
                // Reset after a few seconds
                setTimeout(() => {
                    clickedElement.classList.remove('connecting');
                    clickedElement.querySelector('.server-details').innerHTML = originalDetails;
                }, 3000);
                
            } catch (error) {
                console.error('Failed to connect to server:', error);
                clickedElement.classList.remove('connecting');
            }
        }
        
        async function runDebugSuite() {
            if (debugRunning) return;
            
            debugRunning = true;
            const debugBtn = document.getElementById('runDebugBtn');
            const debugResults = document.getElementById('debugResults');
            const testResults = document.getElementById('testResults');
            
            debugBtn.disabled = true;
            debugBtn.textContent = 'üîÑ Running Debug...';
            testResults.style.display = 'block';
            testResults.innerHTML = '<div class="test-step">üîÑ Starting debug suite...</div>';
            
            try {
                // 1. Basic heartbeat
                testResults.innerHTML += '<div class="test-step">üì° Testing basic connectivity...</div>';
                const heartbeat = await fetch('/api/heartbeat');
                const heartbeatData = await heartbeat.json();
                
                // 2. Pipeline test
                testResults.innerHTML += '<div class="test-step">üîß Testing packet pipeline...</div>';
                const pipeline = await fetch('/api/test-pipeline');
                const pipelineData = await pipeline.json();
                
                // 3. Refresh metrics
                testResults.innerHTML += '<div class="test-step">üìä Refreshing metrics...</div>';
                await refreshMetrics();
                
                // Update debug results
                updateDebugResults(heartbeatData, pipelineData);
                
                // Show detailed results
                testResults.innerHTML += '<div class="test-step">‚úÖ Debug suite completed</div>';
                
                // Add pipeline flow details
                if (pipelineData.packet_flow) {
                    pipelineData.packet_flow.forEach(step => {
                        testResults.innerHTML += `<div class="test-step">${step}</div>`;
                    });
                }
                
            } catch (error) {
                console.error('Debug suite failed:', error);
                testResults.innerHTML += `<div class="test-step">‚ùå Debug suite failed: ${error}</div>`;
            }
            
            debugRunning = false;
            debugBtn.disabled = false;
            debugBtn.textContent = 'üîÑ Run Debug Suite';
        }
        
        function updateDebugResults(heartbeat, pipeline) {
            const debugResults = document.getElementById('debugResults');
            
            const pythonStatus = heartbeat.python_relay.status;
            const goStatus = heartbeat.go_webrtc.status;
            const pipelineStatus = pipeline.python_processing.status;
            
            debugResults.innerHTML = `
                <div class="debug-item">
                    <span>Python Relay</span>
                    <span class="status-indicator status-${pythonStatus}">${pythonStatus.toUpperCase()}</span>
                </div>
                <div class="debug-item">
                    <span>Go WebRTC</span>
                    <span class="status-indicator status-${goStatus}">${goStatus.toUpperCase()}</span>
                </div>
                <div class="debug-item">
                    <span>Pipeline Test</span>
                    <span class="status-indicator status-${pipelineStatus}">${pipelineStatus.toUpperCase()}</span>
                </div>
            `;
        }
        
        async function refreshMetrics() {
            const metricsContainer = document.getElementById('metrics');
            metricsContainer.classList.add('loading');
            
            try {
                const response = await fetch('/api/metrics');
                const text = await response.text();
                const metrics = parsePrometheusMetrics(text);
                
                const metricsHtml = [
                    createMetricCard('Go‚ÜíPython', metrics.go_to_python_total || 0),
                    createMetricCard('To ReHLDS', metrics.pkt_to_udp_total || 0),
                    createMetricCard('From ReHLDS', metrics.python_to_go_total || 0),
                    createMetricCard('Full Pipeline', (metrics.python_to_go_total || 0))
                ].join('');
                
                metricsContainer.innerHTML = metricsHtml;
                
            } catch (error) {
                console.error('Metrics failed:', error);
                metricsContainer.innerHTML = 
                    '<div class="metric-card"><div class="metric-value">Error</div><div class="metric-label">Failed</div></div>';
            }
            
            metricsContainer.classList.remove('loading');
        }
        
        function createMetricCard(label, value) {
            return `
                <div class="metric-card">
                    <div class="metric-value">${value}</div>
                    <div class="metric-label">${label}</div>
                </div>
            `;
        }
        
        function parsePrometheusMetrics(text) {
            const metrics = {};
            const lines = text.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('#') || !line.trim()) continue;
                
                const match = line.match(/^([a-z_]+)\s+([\d.]+)$/);
                if (match) {
                    metrics[match[1]] = parseFloat(match[2]);
                }
            }
            
            return metrics;
        }
        
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = 
                `Last updated: ${now.toLocaleString()}`;
        }
        
        // Update timestamp every time we fetch data
        setInterval(updateTimestamp, 1000);
    </script>
</body>
</html>