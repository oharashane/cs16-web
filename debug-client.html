<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Debug Client</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        .log { background: #111; padding: 10px; border: 1px solid #333; margin: 10px 0; }
        button { padding: 10px; margin: 5px; font-size: 16px; }
        #logs { max-height: 400px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>🔧 WebRTC Relay Debug Client</h1>
    <div>
        <button onclick="testConnection()">Test WebSocket Connection</button>
        <button onclick="testManualWebRTC()">Test Manual WebRTC Handshake</button>
        <button onclick="testYohimikFormat()">Test Yohimik Format</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="logs" class="log"></div>

    <script>
        let ws = null;
        let pc = null;
        let dc = null;
        
        function log(msg) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `<div>[${timestamp}] ${msg}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(msg);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function testConnection() {
            log('🔌 Testing WebSocket connection to relay...');
            
            try {
                ws = new WebSocket('ws://localhost:8090/websocket');
                
                ws.onopen = function() {
                    log('✅ WebSocket connected successfully');
                };
                
                ws.onerror = function(error) {
                    log('❌ WebSocket error: ' + JSON.stringify(error));
                };
                
                ws.onclose = function(event) {
                    log(`🔌 WebSocket closed: code=${event.code}, reason=${event.reason}`);
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log('📥 Received: ' + JSON.stringify(data, null, 2));
                    } catch (e) {
                        log('📥 Received (raw): ' + event.data);
                    }
                };
                
            } catch (error) {
                log('❌ Connection failed: ' + error.message);
            }
        }
        
        async function testManualWebRTC() {
            log('🚀 Starting manual WebRTC handshake...');
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('❌ WebSocket not connected. Click "Test WebSocket Connection" first.');
                return;
            }
            
            try {
                // Create RTCPeerConnection
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                // Create DataChannel
                dc = pc.createDataChannel('gamedata', {
                    ordered: false,
                    maxRetransmits: 0
                });
                
                dc.onopen = function() {
                    log('🎉 DataChannel opened!');
                };
                
                dc.onmessage = function(event) {
                    log('📨 DataChannel message: ' + event.data);
                };
                
                // Handle ICE candidates
                pc.onicecandidate = function(event) {
                    if (event.candidate) {
                        const msg = {
                            event: 'candidate',
                            data: {
                                candidate: event.candidate.candidate,
                                sdpMid: event.candidate.sdpMid,
                                sdpMLineIndex: event.candidate.sdpMLineIndex,
                                usernameFragment: null
                            }
                        };
                        log('📤 Sending ICE candidate...');
                        ws.send(JSON.stringify(msg));
                    }
                };
                
                // Create offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                // Send offer in yohimik format
                const offerMsg = {
                    event: 'offer',
                    data: {
                        type: 'offer',
                        sdp: offer.sdp
                    }
                };
                
                log('📤 Sending offer...');
                ws.send(JSON.stringify(offerMsg));
                
                // Wait for answer
                ws.onmessage = async function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        log('📥 Received: ' + data.event);
                        
                        if (data.event === 'answer') {
                            await pc.setRemoteDescription({
                                type: 'answer',
                                sdp: data.data.sdp
                            });
                            log('✅ Remote description set');
                        }
                    } catch (e) {
                        log('❌ Error processing message: ' + e.message);
                    }
                };
                
            } catch (error) {
                log('❌ Manual WebRTC failed: ' + error.message);
            }
        }
        
        function testYohimikFormat() {
            log('🔍 Testing different message formats...');
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('❌ WebSocket not connected. Click "Test WebSocket Connection" first.');
                return;
            }
            
            // Test 1: Empty message (see what relay responds with)
            log('📤 Test 1: Sending empty message...');
            ws.send('{}');
            
            setTimeout(() => {
                // Test 2: Connected greeting (maybe yohimik expects this?)
                log('📤 Test 2: Sending connected greeting...');
                ws.send(JSON.stringify({event: 'connected'}));
            }, 1000);
            
            setTimeout(() => {
                // Test 3: Hello message
                log('📤 Test 3: Sending hello message...');
                ws.send(JSON.stringify({event: 'hello', data: {}}));
            }, 2000);
            
            setTimeout(() => {
                // Test 4: Standard WebRTC format (not yohimik)
                log('📤 Test 4: Sending standard WebRTC format...');
                ws.send(JSON.stringify({type: 'hello'}));
            }, 3000);
        }
        
        log('🔧 Debug client ready. Click buttons above to test.');
        log('💡 This will help us understand what yohimik is expecting.');
    </script>
</body>
</html>