<!DOCTYPE html>
<html>
<head>
    <title>WebRTC ICE Test</title>
</head>
<body>
    <h1>WebRTC ICE Candidate Test</h1>
    <div id="status"></div>
    <div id="candidates"></div>
    
    <script>
        const statusDiv = document.getElementById('status');
        const candidatesDiv = document.getElementById('candidates');
        
        function log(message, level = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${level}: ${message}`);
            statusDiv.innerHTML += `<div>[${timestamp}] ${level}: ${message}</div>`;
        }
        
        function logCandidate(candidate) {
            console.log('ICE Candidate:', candidate);
            candidatesDiv.innerHTML += `<div><strong>Candidate:</strong> ${candidate.candidate}</div>`;
        }
        
        async function testWebRTC() {
            try {
                log('Connecting to WebSocket...');
                const ws = new WebSocket('ws://localhost:8080/websocket');
                
                ws.onopen = () => {
                    log('WebSocket connected successfully');
                };
                
                ws.onmessage = async (event) => {
                    const message = JSON.parse(event.data);
                    log(`Received: ${message.event}`);
                    
                    if (message.event === 'offer') {
                        log('Received WebRTC offer from server');
                        
                        // Create peer connection
                        const pc = new RTCPeerConnection({
                            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                        });
                        
                        // Log ICE candidates
                        pc.onicecandidate = (event) => {
                            if (event.candidate) {
                                logCandidate(event.candidate);
                            }
                        };
                        
                        // Monitor connection states
                        pc.oniceconnectionstatechange = () => {
                            log(`ICE Connection State: ${pc.iceConnectionState}`);
                        };
                        
                        pc.onconnectionstatechange = () => {
                            log(`Connection State: ${pc.connectionState}`);
                        };
                        
                        // Handle data channels
                        pc.ondatachannel = (event) => {
                            const channel = event.channel;
                            log(`Data channel received: ${channel.label}`);
                            
                            channel.onopen = () => {
                                log(`Data channel ${channel.label} opened`);
                            };
                        };
                        
                        // Set remote description and create answer
                        await pc.setRemoteDescription(message.data);
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        
                        // Send answer back
                        ws.send(JSON.stringify({
                            event: 'answer',
                            data: answer
                        }));
                        
                        log('Answer sent to server');
                    }
                    
                    if (message.event === 'candidate') {
                        log(`Server ICE candidate: ${message.data.candidate}`);
                        // Check if it contains Docker bridge IP
                        if (message.data.candidate.includes('172.')) {
                            log('⚠️  WARNING: Docker bridge IP detected in ICE candidate!', 'WARN');
                        } else {
                            log('✅ ICE candidate uses proper IP', 'SUCCESS');
                        }
                    }
                };
                
                ws.onerror = (error) => {
                    log(`WebSocket error: ${error}`, 'ERROR');
                };
                
                ws.onclose = () => {
                    log('WebSocket closed');
                };
                
            } catch (error) {
                log(`Error: ${error}`, 'ERROR');
            }
        }
        
        // Start test when page loads
        window.onload = testWebRTC;
    </script>
</body>
</html>