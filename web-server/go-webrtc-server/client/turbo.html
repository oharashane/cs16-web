<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CS 1.6 Web Client (TURBO MODE)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html, body { 
      margin: 0; 
      height: 100%; 
      background: #000; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
        #canvas { 
      width: 100%; 
      height: 100%; 
      display: block; 
      /* TURBO MODE: nearest-neighbor upscale for pixelated look */
      image-rendering: pixelated; 
      image-rendering: crisp-edges; 
    }
    
    /* Game-specific styles from index.html */
    .notDraggable {
        user-select: none;
        -webkit-user-drag: none;
        pointer-events: none;
    }

    @keyframes pulsate {
        0% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        100% {
            transform: translate(-50%, -50%) scale(0.5);
            opacity: 0.75;
        }
    }

    @keyframes pulsate-end {
        0% {
            transform: translate(-50%, -50%) scale(0.75);
            opacity: 0.87;
        }
        100% {
            transform: translate(-50%, -50%) scale(1);
            opacity: 0;
        }
    }

    img {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 100vw;
        max-height: 100vh;
        animation-name: pulsate;
        animation-duration: 0.75s;
        animation-iteration-count: infinite;
        animation-direction: alternate;
        z-index: 2;
        transition: opacity ease-in-out 0.5s;
    }

    canvas {
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
    }

    form {
        margin: 0;
        padding: 16px;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2;
        display: flex;
        justify-content: space-between;
        color: white;
    }

    #warning {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 3;
        text-align: center;
        color: red;
        opacity: 0;
        transition: opacity ease-in-out 0.5s;
    }
  </style>
</head>
<body>


  <!-- Use the same id your client expects; many Emscripten builds look up #canvas -->
  <canvas id="canvas"></canvas>
  
  <!-- Loading image -->
  <img id="logo" alt="Loading..." class="notDraggable" src="/assets/loading.jpg"/>
  
  <!-- Form for player name input -->
  <form id="form">
      <label>
          Player name
          <input id="username" type="text" required/>
      </label>
      <button type="submit">
          GO
      </button>
  </form>
  
  <!-- Warning message -->
  <p id="warning" class="notDraggable">If it's not starting, try to enable microphone and refresh</p>

  <script>
    // Parse server parameter from URL query string (same as index.html)
    function getServerPort() {
        const urlParams = new URLSearchParams(window.location.search);
        const serverPort = urlParams.get('server');
        const port = parseInt(serverPort);
        
        // Validate port is in CS server range
        if (port >= 27000 && port <= 27030) {
            return port;
        }
        
        console.warn('Invalid or missing server parameter:', serverPort);
        return null;
    }
    
    // Make server port globally available (for debugging and for Xash client)
    window.CS16_SERVER_PORT = getServerPort();
    
    console.log('CS16 Server Port (from ?server= parameter):', window.CS16_SERVER_PORT || 'unknown');
    
    // ----- TURBO MODE URL params: ?scale=0.5&maxdpr=1 -----
    const params   = new URL(location.href).searchParams;
    const SCALE    = Math.max(0.25, Math.min(1, parseFloat(params.get('scale') || '0.75'))); // 0.25..1, default 0.75
    const MAX_DPR  = parseFloat(params.get('maxdpr') || '1'); // 0 = no clamp, default 1 (clamp to 1x)
    
    // TURBO MODE: Additional performance flags
    const TURBO_AGGRESSIVE = params.get('turbo') === 'aggressive'; // ?turbo=aggressive for max performance
    const TURBO_ULTRA = params.get('turbo') === 'ultra'; // ?turbo=ultra for ultra performance

    // If you control the Emscripten Module, point it at this canvas and tweak GL hints:
    window.Module = window.Module || {};
    Module.canvas = (function () { return document.getElementById('canvas'); })();
    
    // TURBO MODE: Aggressive WebGL optimizations for maximum performance
    Module.webglContextAttributes = Object.assign(
      { 
        antialias: false,           // Disable antialiasing for performance
        alpha: false,               // Disable alpha channel
        depth: true,                // Keep depth buffer
        stencil: false,             // Disable stencil buffer
        desynchronized: true,       // Async rendering
        powerPreference: 'high-performance', // Prefer dedicated GPU
        preserveDrawingBuffer: false, // Don't preserve buffer
        failIfMajorPerformanceCaveat: false, // Don't fail on performance caveats
        xrCompatible: false,        // Disable XR for performance
        premultipliedAlpha: false   // Disable alpha premultiplication
      },
      Module.webglContextAttributes || {}
    );

    function effectiveDpr() {
      const dpr = window.devicePixelRatio || 1;
      return (MAX_DPR > 0 ? Math.min(dpr, MAX_DPR) : dpr) * SCALE;
    }

        function resizeCanvas() {
        const canvas = Module.canvas || document.getElementById('canvas');
        if (!canvas) return;
      
      // TURBO MODE: Use more reasonable CSS dimensions for better performance
      // Instead of full window, use a more standard game resolution
      let maxWidth = 1920;  // Max reasonable game width
      let maxHeight = 1080; // Max reasonable game height
      
      // TURBO AGGRESSIVE MODE: Further reduce dimensions for maximum performance
      if (TURBO_AGGRESSIVE) {
          maxWidth = 1280;
          maxHeight = 720;
          console.log('ðŸš€ TURBO AGGRESSIVE MODE: Using 720p max resolution');
      }
      
      // TURBO ULTRA MODE: Ultra-low resolution for maximum performance
      if (TURBO_ULTRA) {
          maxWidth = 800;
          maxHeight = 600;
          console.log('ðŸš€ TURBO ULTRA MODE: Using 600p max resolution');
      }
      
      const cssW = Math.min(window.innerWidth, maxWidth);
      const cssH = Math.min(window.innerHeight, maxHeight);
      
      canvas.style.width  = cssW + 'px';
      canvas.style.height = cssH + 'px';

      // Backing store size (controls render resolution) - THIS IS THE KEY TO TURBO MODE
      const dpr = effectiveDpr();
      const w = Math.max(1, Math.floor(cssW * dpr));
      const h = Math.max(1, Math.floor(cssH * dpr));

      if (canvas.width !== w || canvas.height !== h) {
            canvas.width  = w;
            canvas.height = h;
            
            // Log the TURBO mode effect
            const originalSize = window.innerWidth * window.innerHeight * (window.devicePixelRatio || 1);
            const turboSize = w * h;
            const performanceGain = ((originalSize - turboSize) / originalSize * 100).toFixed(1);
            
            console.log(`ðŸš€ TURBO MODE: Canvas resized to ${w}Ã—${h} (CSS: ${cssW}Ã—${cssH}, DPR: ${dpr})`);
            console.log(`ðŸš€ TURBO MODE: Performance gain: ${performanceGain}% reduction in render pixels`);
            
            // Force WebGL viewport update if possible
            if (Module.ctx && Module.ctx.viewport) {
                Module.ctx.viewport(0, 0, w, h);
                console.log('ðŸš€ TURBO MODE: WebGL viewport updated to match canvas size');
            }
        }
    }

    // Handle server parameter for automatic connection
    function handleServerParameter() {
      const serverPort = params.get('server');
      if (serverPort) {
        console.log(`TURBO MODE: Server parameter detected: ${serverPort}`);
        // The main.js will handle the connection when it loads
      }
    }

    // Event listeners
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', resizeCanvas);
    document.addEventListener('DOMContentLoaded', () => {
      resizeCanvas();
      handleServerParameter();
    });

    // Kick once more after the engine boots (covers late canvas grabs)
    setTimeout(resizeCanvas, 0);
    setTimeout(resizeCanvas, 500);
    
    // Additional resize calls to ensure proper initialization
    setTimeout(resizeCanvas, 1000);
    setTimeout(resizeCanvas, 2000);
    
    // Log TURBO mode initialization
    console.log(`ðŸš€ TURBO MODE initialized with scale=${SCALE}, maxdpr=${MAX_DPR}`);
    console.log(`Device pixel ratio: ${window.devicePixelRatio || 1}`);
    console.log(`Effective DPR: ${effectiveDpr()}`);
    
    // Log TURBO mode configuration
    if (TURBO_AGGRESSIVE) {
        console.log('ðŸš€ TURBO AGGRESSIVE MODE: Maximum performance optimization enabled');
    } else if (TURBO_ULTRA) {
        console.log('ðŸš€ TURBO ULTRA MODE: Ultra performance optimization enabled');
    } else {
        console.log('ðŸš€ TURBO MODE: Standard performance optimization enabled');
    }
    
    // Calculate and log expected performance improvement
    const expectedReduction = ((1 - SCALE) * 100).toFixed(1);
    console.log(`ðŸš€ TURBO MODE: Expected render resolution reduction: ${expectedReduction}%`);
    
    // Configure WASM memory to prevent growth during connection (same as index.html)
    window.Module = {
        INITIAL_MEMORY: 536870912,  // 512MB - fixed ArrayBuffer issues
        ALLOW_MEMORY_GROWTH: 0,     // Disable memory growth entirely
        
        // DO NOT ADD ANYTHING HERE - onRuntimeInitialized DOESN'T WORK!
        onRuntimeInitialized: function() {
            // This function never gets called properly - don't use it!
        }
    };
    
    // === FUTURE PERFORMANCE OPTIMIZATIONS ===
    // Use this DOMContentLoaded event for any future client-side performance tweaks
    // NOTE: DOMContentLoaded runs and shows console logs, but performance tweaks had no effect
    document.addEventListener('DOMContentLoaded', function() {
        // Canvas/WebGL optimizations can go here if needed
        // This actually works unlike onRuntimeInitialized
        console.log('TURBO MODE: DOM loaded, ready for game initialization');
    });
  </script>

  <!-- Your existing script loader below (the compiled main.js from yohimik's build). -->
  <script type="module" crossorigin src="/assets/main-CqZe0kYo.js"></script>
</body>
</html>
