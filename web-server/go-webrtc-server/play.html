<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS1.6 Web - Play</title>
    <link rel="icon" href="/assets/favicon.png" type="image/png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: url('/assets/background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: white;
            height: 100vh;
            overflow: hidden;
            /* Fallback gradient */
            background-color: #1e3c72;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 60, 114, 0.7);
            z-index: -1;
        }
        
        .play-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        
        /* Left Sidebar */
        .server-sidebar {
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-right: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        
        .sidebar-header h1 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #4CAF50;
        }
        
        .sidebar-header p {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .server-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .server-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }
        

        
        .server-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.5);
            transform: translateY(-2px);
        }
        
        .server-item.connecting {
            border: 2px solid #ff9800;
            opacity: 0.7;
        }
        
        .server-item.offline {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .server-name {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .server-details {
            font-size: 0.85em;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .server-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .server-status.online {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .server-status.offline {
            background: #f44336;
        }
        
        .server-status.unknown {
            background: #ff9800;
        }
        
        .refresh-info {
            padding: 15px;
            text-align: center;
            font-size: 0.8em;
            opacity: 0.7;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .refresh-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Right Side - Game Client */
        .game-client {
            flex: 1;
            position: relative;
            background: #000;
        }
        
        .game-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }
        
        /* Disconnection Overlay */
        .disconnect-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .disconnect-content {
            text-align: center;
            padding: 40px;
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid #f44336;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .disconnect-icon {
            font-size: 4em;
            margin-bottom: 20px;
            color: #f44336;
        }
        
        .disconnect-title {
            font-size: 2em;
            margin-bottom: 15px;
            color: #f44336;
        }
        
        .disconnect-message {
            font-size: 1.2em;
            margin-bottom: 25px;
            opacity: 0.9;
        }
        
        .disconnect-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
        }
        
        .btn-primary:hover {
            background: rgba(76, 175, 80, 0.4);
        }
        
        .btn-danger {
            background: rgba(244, 67, 54, 0.3);
            border-color: rgba(244, 67, 54, 0.5);
        }
        
        .btn-danger:hover {
            background: rgba(244, 67, 54, 0.4);
        }
        
        /* Loading states */
        .loading {
            opacity: 0.5;
        }
        
        /* Scrollbar styling */
        .server-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .server-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .server-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .server-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .play-container {
                flex-direction: column;
            }
            
            .server-sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            }
            
            .game-client {
                height: calc(100vh - 200px);
            }
        }
    </style>
</head>
<body>
    <div class="play-container">
        <!-- Left Sidebar - Server List -->
        <div class="server-sidebar">
            <div class="sidebar-header">
                <h1>CS1.6 Web</h1>
                <p>Click a server to connect</p>
                <a href="/" style="color: #81C784; text-decoration: none; font-size: 0.9em; margin-top: 10px; display: inline-block;">
                    ‚Üê Back to Dashboard
                </a>
            </div>
            
            <div class="server-list" id="serverList">
                <div class="server-item loading-placeholder">
                    <div class="server-name">Loading servers...</div>
                    <div class="server-details">Please wait...</div>
                    <div class="server-status unknown"></div>
                </div>
            </div>
            
            <div class="refresh-info">
                <span class="refresh-indicator"></span>
                Auto-refresh every 5 seconds
            </div>
        </div>
        
        <!-- Right Side - Game Client -->
        <div class="game-client">
            <iframe 
                id="gameIframe" 
                class="game-iframe" 
                src="/client"
                title="Counter-Strike 1.6 Client">
            </iframe>
            
            <!-- Disconnection Overlay -->
            <div class="disconnect-overlay" id="disconnectOverlay">
                <div class="disconnect-content">
                    <div class="disconnect-icon">üîå</div>
                    <div class="disconnect-title">Disconnected</div>
                    <div class="disconnect-message">
                        The game client has disconnected or encountered an error.
                    </div>
                    <div class="disconnect-actions">
                        <button class="btn btn-primary" onclick="reconnectToCurrentServer()">
                            Reconnect
                        </button>
                        <a href="/" class="btn btn-danger">
                            Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentServer = null;
        let serverRefreshInterval = null;
        let disconnectCheckInterval = null;
        let lastDisconnectCheck = Date.now();
        
        // Initialize the play page
        window.addEventListener('load', () => {
            loadGameServers();
            startServerRefresh();
            startDisconnectMonitoring();
            
            // Check if there's a server parameter in the URL
            const urlParams = new URLSearchParams(window.location.search);
            const serverPort = urlParams.get('server');
            if (serverPort) {
                console.log('Initial server parameter:', serverPort);
            }
        });
        
        // Load and display available game servers
        async function loadGameServers() {
            try {
                const response = await fetch('/api/servers');
                const data = await response.json();
                
                updateServerList(data.servers);
                
            } catch (error) {
                console.error('Failed to load servers:', error);
                showServerError();
            }
        }
        
        // Update server list without flashing
        function updateServerList(servers) {
            const serverList = document.getElementById('serverList');
            
            // Remove loading placeholder if servers are found
            const loadingPlaceholder = serverList.querySelector('.loading-placeholder');
            if (loadingPlaceholder && Object.keys(servers).length > 0) {
                loadingPlaceholder.remove();
            }
            
            if (Object.keys(servers).length === 0) {
                if (!document.querySelector('.server-item.no-servers')) {
                    serverList.innerHTML = `
                        <div class="server-item offline no-servers">
                            <div class="server-name">No servers found</div>
                            <div class="server-details">No CS1.6 servers detected</div>
                            <div class="server-status offline"></div>
                        </div>
                    `;
                }
                return;
            }
            
            // Get existing server elements
            const existingServers = new Map();
            serverList.querySelectorAll('.server-item[data-server-id]').forEach(el => {
                const serverId = el.getAttribute('data-server-id');
                existingServers.set(serverId, el);
            });
            
            // Process each server
            const processedIds = new Set();
            
            for (const [serverName, serverInfo] of Object.entries(servers)) {
                const serverId = `${serverInfo.host}:${serverInfo.port}`;
                processedIds.add(serverId);
                
                let serverElement = existingServers.get(serverId);
                
                if (serverElement) {
                    // Update existing element
                    updateServerElement(serverElement, serverName, serverInfo);
                } else {
                    // Create new element
                    serverElement = createServerElement(serverName, serverInfo);
                    serverList.appendChild(serverElement);
                }
            }
            
            // Remove servers that are no longer available
            existingServers.forEach((element, serverId) => {
                if (!processedIds.has(serverId)) {
                    element.remove();
                }
            });
            
            // No animation needed - just update data silently
        }
        
        // Update existing server element without recreating
        function updateServerElement(element, serverName, serverInfo) {
            const statusClass = serverInfo.status === 'online' ? 'online' : 'offline';
            const isOnline = serverInfo.status === 'online';
            
            // Update classes
            element.className = 'server-item';
            if (!isOnline) {
                element.classList.add('offline');
            }
            
            // Update click handler
            if (isOnline) {
                element.onclick = () => connectToServer(serverName, serverInfo);
            } else {
                element.onclick = null;
            }
            
            // Update content only if it changed
            const nameEl = element.querySelector('.server-name');
            const detailsEl = element.querySelector('.server-details');
            const statusEl = element.querySelector('.server-status');
            
            if (nameEl.textContent !== serverInfo.name) {
                nameEl.textContent = serverInfo.name;
            }
            
            const playerCount = isOnline ? `${serverInfo.players}/${serverInfo.max_players}` : '0/0';
            const mapName = serverInfo.map !== 'unknown' ? serverInfo.map : '';
            const newDetails = `${mapName ? `${mapName}<br>` : ''}${playerCount} players`;
            
            if (detailsEl.innerHTML !== newDetails) {
                detailsEl.innerHTML = newDetails;
            }
            
            // Update status indicator
            statusEl.className = `server-status ${statusClass}`;
        }
        
        // Show server error without clearing the list
        function showServerError() {
            const serverList = document.getElementById('serverList');
            const existingError = serverList.querySelector('.server-item.error');
            
            if (!existingError) {
                const errorElement = document.createElement('div');
                errorElement.className = 'server-item error';
                errorElement.innerHTML = `
                    <div class="server-name">Error loading servers</div>
                    <div class="server-details">Failed to fetch server list</div>
                    <div class="server-status offline"></div>
                `;
                serverList.appendChild(errorElement);
            }
        }
        
        // Create a server list item element
        function createServerElement(serverName, serverInfo) {
            const serverElement = document.createElement('div');
            serverElement.className = 'server-item';
            
            // Add unique identifier for seamless updates
            const serverId = `${serverInfo.host}:${serverInfo.port}`;
            serverElement.setAttribute('data-server-id', serverId);
            
            const statusClass = serverInfo.status === 'online' ? 'online' : 'offline';
            const isOnline = serverInfo.status === 'online';
            
            if (!isOnline) {
                serverElement.classList.add('offline');
            } else {
                serverElement.onclick = () => connectToServer(serverName, serverInfo);
            }
            
            // Create player count display
            const playerCount = isOnline ? 
                `${serverInfo.players}/${serverInfo.max_players}` : 
                '0/0';
            
            // Create map display
            const mapName = serverInfo.map !== 'unknown' ? serverInfo.map : '';
            
            serverElement.innerHTML = `
                <div class="server-name">${serverInfo.name}</div>
                <div class="server-details">
                    ${mapName ? `${mapName}<br>` : ''}
                    ${playerCount} players
                </div>
                <div class="server-status ${statusClass}"></div>
            `;
            
            return serverElement;
        }
        
        // Connect to a specific server
        async function connectToServer(serverName, serverInfo) {
            // Security: Validate port is within allowed CS server range
            const port = parseInt(serverInfo.port);
            if (port < 27000 || port > 27030) {
                console.error(`Invalid port ${port}. Must be between 27000-27030`);
                alert(`Error: Invalid server port ${port}. Only CS servers (ports 27000-27030) are allowed.`);
                return;
            }
            
            // Update UI to show connecting state
            const serverElements = document.querySelectorAll('.server-item');
            const clickedElement = event.currentTarget;
            
            // Reset all server states
            serverElements.forEach(el => el.classList.remove('connecting'));
            clickedElement.classList.add('connecting');
            
            try {
                // Store current server info
                currentServer = serverInfo;
                
                // Update iframe to connect to the selected server
                const iframe = document.getElementById('gameIframe');
                const clientUrl = `/client?server=${serverInfo.port}`;
                
                console.log(`Connecting to server: ${serverInfo.name} (${serverInfo.host}:${serverInfo.port})`);
                console.log(`Loading client URL: ${clientUrl}`);
                
                // Update iframe source
                iframe.src = clientUrl;
                
                // Hide disconnect overlay if it was showing
                hideDisconnectOverlay();
                
                // Reset connecting state after a few seconds
                setTimeout(() => {
                    clickedElement.classList.remove('connecting');
                }, 3000);
                
            } catch (error) {
                console.error('Failed to connect to server:', error);
                clickedElement.classList.remove('connecting');
            }
        }
        
        // Start automatic server list refresh
        function startServerRefresh() {
            serverRefreshInterval = setInterval(() => {
                loadGameServers();
            }, 5000);
        }
        
        // Start monitoring for disconnections
        function startDisconnectMonitoring() {
            disconnectCheckInterval = setInterval(() => {
                checkForDisconnection();
            }, 2000); // Check every 2 seconds
            
            // Also monitor iframe load events
            const iframe = document.getElementById('gameIframe');
            iframe.addEventListener('load', () => {
                console.log('üö® ENGINE MONITOR: Game iframe loaded successfully');
                lastDisconnectCheck = Date.now();
                hideDisconnectOverlay();
                
                // Check iframe content after load
                setTimeout(() => {
                    try {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (iframeDoc) {
                            const canvas = iframeDoc.querySelector('canvas');
                            const form = iframeDoc.querySelector('#form');
                            console.log('üö® ENGINE MONITOR: Iframe loaded - Canvas:', !!canvas, 'Form:', !!form);
                        }
                    } catch (e) {
                        console.log('üö® ENGINE MONITOR: Could not inspect iframe content after load');
                    }
                }, 1000);
            });
            
            iframe.addEventListener('error', () => {
                console.log('üö® ENGINE MONITOR: Game iframe failed to load');
                showDisconnectOverlay('Iframe Error', 'Failed to load the game client.');
            });
        }
        
        // Check if the game client has disconnected or errored
        function checkForDisconnection() {
            const iframe = document.getElementById('gameIframe');
            
            try {
                // Try to access iframe content to check if it's responsive
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // If we can access the document, check for error indicators
                if (iframeDoc) {
                    // Look for common error indicators
                    const errorElements = iframeDoc.querySelectorAll('.error, .disconnect, .offline');
                    const canvas = iframeDoc.querySelector('canvas');
                    const form = iframeDoc.querySelector('#form');
                    const logo = iframeDoc.querySelector('#logo');
                    const warning = iframeDoc.querySelector('#warning');
                    
                    // Check if canvas is visible and responsive
                    if (canvas && canvas.style.display !== 'none') {
                        // Canvas is visible, client might be working
                        lastDisconnectCheck = Date.now();
                        hideDisconnectOverlay();
                        return;
                    }
                    
                    // Check if we're back to the login form (engine exited)
                    if (form && form.style.display !== 'none') {
                        console.log('üö® ENGINE MONITOR: WebXash engine exited - login form visible');
                        showDisconnectOverlay('WebXash Engine Exited', 'The game engine has exited and returned to the login screen.');
                        return;
                    }
                    
                    // Check if loading logo is stuck (engine crashed)
                    if (logo && logo.style.animationPlayState === 'paused') {
                        console.log('üö® ENGINE MONITOR: WebXash engine appears stuck on loading');
                        showDisconnectOverlay('Engine Stuck', 'The game engine appears to be stuck on the loading screen.');
                        return;
                    }
                    
                    // Check if warning message is visible (common when engine fails)
                    if (warning && warning.style.opacity !== '0') {
                        console.log('üö® ENGINE MONITOR: Warning message visible - engine may have issues');
                        showDisconnectOverlay('Engine Warning', 'The game engine is showing a warning message.');
                        return;
                    }
                    
                    // Check if we have a body but no canvas (engine loaded but no game)
                    if (iframeDoc.body && !canvas) {
                        console.log('üö® ENGINE MONITOR: Document loaded but no canvas found - engine may not be running');
                        showDisconnectOverlay('No Game Canvas', 'The game engine loaded but no game canvas is visible.');
                        return;
                    }
                    
                    // Check if document is in a loading state
                    if (iframeDoc.readyState !== 'complete') {
                        console.log('üö® ENGINE MONITOR: Document not fully loaded - readyState:', iframeDoc.readyState);
                    }
                }
                
                // If we can't access the iframe content, it might be disconnected
                // Check if it's been a while since we last saw activity
                const timeSinceLastCheck = Date.now() - lastDisconnectCheck;
                if (timeSinceLastCheck > 10000) { // 10 seconds
                    console.log('üö® ENGINE MONITOR: Cannot access iframe content for 10+ seconds');
                    showDisconnectOverlay('Connection Lost', 'Unable to communicate with the game client.');
                }
                
            } catch (error) {
                // If we can't access the iframe content, it might be disconnected
                console.log('üö® ENGINE MONITOR: Error accessing iframe content:', error.message);
                
                const timeSinceLastCheck = Date.now() - lastDisconnectCheck;
                if (timeSinceLastCheck > 10000) { // 10 seconds
                    showDisconnectOverlay('Connection Lost', 'Unable to communicate with the game client.');
                }
            }
        }
        
        // Show the disconnection overlay
        function showDisconnectOverlay(title = 'Disconnected', message = 'The game client has disconnected or encountered an error.') {
            const overlay = document.getElementById('disconnectOverlay');
            const titleEl = overlay.querySelector('.disconnect-title');
            const messageEl = overlay.querySelector('.disconnect-message');
            
            // Update the overlay content
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            overlay.style.display = 'flex';
        }
        
        // Hide the disconnection overlay
        function hideDisconnectOverlay() {
            const overlay = document.getElementById('disconnectOverlay');
            overlay.style.display = 'none';
        }
        
        // Reconnect to the current server
        function reconnectToCurrentServer() {
            if (currentServer) {
                const iframe = document.getElementById('gameIframe');
                const clientUrl = `/client?server=${currentServer.port}`;
                
                console.log(`Reconnecting to server: ${currentServer.name} (${currentServer.host}:${currentServer.port})`);
                
                // Reload the iframe
                iframe.src = clientUrl;
                
                // Hide the overlay
                hideDisconnectOverlay();
                
                // Reset the disconnect check timer
                lastDisconnectCheck = Date.now();
            } else {
                // No current server, go back to dashboard
                window.location.href = '/';
            }
        }
        
        // Clean up intervals when page unloads
        window.addEventListener('beforeunload', () => {
            if (serverRefreshInterval) {
                clearInterval(serverRefreshInterval);
            }
            if (disconnectCheckInterval) {
                clearInterval(disconnectCheckInterval);
            }
        });
        
        // Listen for messages from the iframe (if needed)
        window.addEventListener('message', (event) => {
            // Handle any messages from the game client iframe
            console.log('Message from iframe:', event.data);
        });
    </script>
</body>
</html>
